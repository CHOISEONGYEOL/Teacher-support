<!DOCTYPE html>
<html lang="ko" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë¬¼ìˆ˜ì§€ í‰í˜• - ê°ê´€ì‹ ëª¨ë“œ</title>
    <script src="../theme.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #1a1a2e;
            --bg-secondary: #16213e;
            --bg-tertiary: #0f3460;
            --text-primary: #fff;
            --text-secondary: #aaa;
            --text-muted: #888;
            --card-bg: rgba(255,255,255,0.05);
            --card-border: rgba(255,255,255,0.1);
            --shadow-color: rgba(0,0,0,0.3);
        }

        [data-theme="light"] {
            --bg-primary: #f5f7fa;
            --bg-secondary: #e8ecf1;
            --bg-tertiary: #dce3eb;
            --text-primary: #1a1a1a;
            --text-secondary: #333333;
            --text-muted: #555555;
            --card-bg: rgba(255,255,255,0.9);
            --card-border: rgba(0,0,0,0.15);
            --shadow-color: rgba(0,0,0,0.15);
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 50%, var(--bg-tertiary) 100%);
            min-height: 100vh;
            color: var(--text-primary);
            padding: 20px;
            transition: background 0.3s, color 0.3s;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .back-btn {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            color: var(--text-secondary);
            padding: 10px 20px;
            border-radius: 8px;
            text-decoration: none;
            font-size: 0.9rem;
            transition: all 0.3s;
        }

        .back-btn:hover {
            background: rgba(255,255,255,0.1);
            color: var(--text-primary);
        }

        .score-display {
            font-size: 1.2rem;
            color: #3498db;
        }

        .title {
            text-align: center;
            margin-bottom: 20px;
        }

        .title h1 {
            font-size: 1.5rem;
            color: #3498db;
            margin-bottom: 5px;
        }

        .title p {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .diagram-container {
            background: var(--card-bg);
            border: 2px solid var(--card-border);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .diagram {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }

        /* ëŒ€ê¸° ì˜ì—­ */
        .atmosphere {
            width: 100%;
            text-align: center;
            padding: 15px;
            background: rgba(155, 89, 182, 0.15);
            border: 2px solid rgba(155, 89, 182, 0.5);
            border-radius: 12px;
        }

        .atmosphere-title {
            font-size: 1.1rem;
            font-weight: bold;
            color: #9b59b6;
            margin-bottom: 10px;
        }

        .storage-box {
            display: inline-block;
            background: rgba(155, 89, 182, 0.2);
            padding: 10px 20px;
            border-radius: 8px;
            text-align: center;
        }

        .storage-label {
            font-size: 0.8rem;
            color: #9b59b6;
            margin-bottom: 3px;
        }

        .storage-value {
            font-size: 1.3rem;
            font-weight: bold;
            color: #9b59b6;
        }

        .storage-value.blank {
            color: #e74c3c;
        }

        /* í™”ì‚´í‘œ ì˜ì—­ */
        .arrows-section {
            display: flex;
            justify-content: space-around;
            width: 100%;
            padding: 5px 0;
        }

        .arrow-group {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
        }

        .arrow-up {
            font-size: 1.2rem;
            color: #e74c3c;
        }

        .arrow-down {
            font-size: 1.2rem;
            color: #3498db;
        }

        .arrow-label {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        /* ì§€í‘œë©´ ì˜ì—­ */
        .surface-section {
            display: flex;
            justify-content: center;
            align-items: stretch;
            gap: 15px;
            width: 100%;
            flex-wrap: wrap;
        }

        .region {
            text-align: center;
            padding: 15px;
            border-radius: 12px;
            min-width: 180px;
            flex: 1;
            max-width: 250px;
        }

        .region.land {
            background: rgba(139, 69, 19, 0.2);
            border: 2px solid rgba(139, 69, 19, 0.5);
        }

        .region.ocean {
            background: rgba(52, 152, 219, 0.2);
            border: 2px solid rgba(52, 152, 219, 0.5);
        }

        .region-title {
            font-size: 1rem;
            font-weight: bold;
            margin-bottom: 12px;
        }

        .region.land .region-title {
            color: #d4a574;
        }

        .region.ocean .region-title {
            color: #3498db;
        }

        .variable-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 8px 0;
            padding: 8px;
            background: rgba(0,0,0,0.2);
            border-radius: 6px;
        }

        .variable-label {
            font-weight: bold;
            color: var(--text-secondary);
            font-size: 0.85rem;
        }

        .variable-value {
            font-size: 1.1rem;
            font-weight: bold;
            color: #1abc9c;
            min-width: 40px;
            text-align: right;
        }

        .variable-value.blank {
            color: #e74c3c;
            font-size: 1.2rem;
        }

        /* ìœ ì¶œëŸ‰ */
        .runoff-section {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 10px;
            background: rgba(26, 188, 156, 0.1);
            border: 2px dashed rgba(26, 188, 156, 0.5);
            border-radius: 12px;
        }

        .runoff-label {
            color: #1abc9c;
            font-weight: bold;
            font-size: 0.85rem;
            margin-right: 8px;
        }

        .runoff-arrow {
            font-size: 1.2rem;
            color: #1abc9c;
            margin: 0 10px;
        }

        .runoff-value {
            font-size: 1.1rem;
            font-weight: bold;
            color: #1abc9c;
        }

        .runoff-value.blank {
            color: #e74c3c;
        }

        .question-info {
            text-align: center;
            margin-bottom: 15px;
            padding: 10px;
            background: rgba(52, 152, 219, 0.1);
            border: 2px solid rgba(52, 152, 219, 0.3);
            border-radius: 8px;
            color: #3498db;
            font-size: 1rem;
        }

        .choices-container {
            display: flex;
            flex-direction: row;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .choice-btn {
            padding: 12px 16px;
            background: var(--card-bg);
            border: 2px solid var(--card-border);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            min-width: 80px;
        }

        .choice-btn:hover:not(.disabled) {
            border-color: #3498db;
            background: rgba(52, 152, 219, 0.1);
            transform: translateY(-3px);
        }

        .choice-btn.selected {
            border-color: #3498db;
            background: rgba(52, 152, 219, 0.2);
        }

        .choice-btn.correct {
            border-color: #27ae60;
            background: rgba(39, 174, 96, 0.2);
        }

        .choice-btn.incorrect {
            border-color: #e74c3c;
            background: rgba(231, 76, 60, 0.2);
        }

        .choice-btn.disabled {
            cursor: not-allowed;
            opacity: 0.7;
        }

        .choice-number {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: var(--card-border);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.85rem;
        }

        .equations-box {
            background: var(--card-bg);
            border: 2px solid var(--card-border);
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 15px;
        }

        .equations-title {
            color: #3498db;
            font-size: 0.9rem;
            margin-bottom: 10px;
            text-align: center;
        }

        .equation-grid {
            display: flex;
            justify-content: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .equation {
            font-family: 'Courier New', monospace;
            padding: 6px 12px;
            background: rgba(0,0,0,0.2);
            border-radius: 6px;
            color: var(--text-muted);
            font-size: 0.8rem;
            text-align: center;
        }

        .controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 15px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(52, 152, 219, 0.3);
        }

        .feedback {
            text-align: center;
            padding: 12px;
            border-radius: 10px;
            margin-top: 15px;
            display: none;
            font-size: 0.9rem;
        }

        .feedback.correct {
            display: block;
            background: rgba(39, 174, 96, 0.2);
            border: 2px solid #27ae60;
            color: #27ae60;
        }

        .feedback.incorrect {
            display: block;
            background: rgba(231, 76, 60, 0.2);
            border: 2px solid #e74c3c;
            color: #e74c3c;
        }

        .verification {
            background: var(--card-bg);
            border: 2px solid var(--card-border);
            border-radius: 10px;
            padding: 12px;
            margin-top: 15px;
            display: none;
        }

        .verification.show {
            display: block;
        }

        .verification-title {
            color: #3498db;
            margin-bottom: 10px;
            text-align: center;
            font-size: 0.9rem;
        }

        .verification-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 10px;
            margin: 4px 0;
            background: rgba(0,0,0,0.2);
            border-radius: 6px;
            flex-wrap: wrap;
            gap: 8px;
            font-size: 0.8rem;
        }

        .verification-status {
            font-weight: bold;
        }

        .verification-status.balanced {
            color: #27ae60;
        }

        @media (max-width: 600px) {
            .surface-section {
                flex-direction: column;
            }
            .region {
                max-width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <a href="index.html" class="back-btn">â† ëª¨ë“œ ì„ íƒ</a>
            <div class="score-display">ì ìˆ˜: <span id="score">0</span> / <span id="total">0</span></div>
        </div>

        <div class="title">
            <h1>ğŸ’§ ë¬¼ìˆ˜ì§€ í‰í˜• - ê°ê´€ì‹</h1>
            <p>5ê°œì˜ ë³´ê¸° ì¤‘ ì •ë‹µì„ ì„ íƒí•˜ì„¸ìš”</p>
        </div>

        <div class="diagram-container">
            <div class="diagram">
                <!-- ëŒ€ê¸° ì˜ì—­ -->
                <div class="atmosphere">
                    <div class="atmosphere-title">â˜ï¸ ëŒ€ê¸°</div>
                    <div class="storage-box">
                        <div class="storage-label">ëŒ€ê¸° ì¤‘ ìˆ˜ì¦ê¸° (W)</div>
                        <div class="storage-value" id="W"></div>
                    </div>
                </div>

                <!-- í™”ì‚´í‘œ -->
                <div class="arrows-section">
                    <div class="arrow-group">
                        <span class="arrow-up">â†‘ ì¦ë°œ</span>
                        <span class="arrow-down">â†“ ê°•ìˆ˜</span>
                        <span class="arrow-label">ìœ¡ì§€</span>
                    </div>
                    <div class="arrow-group">
                        <span class="arrow-up">â†‘ ì¦ë°œ</span>
                        <span class="arrow-down">â†“ ê°•ìˆ˜</span>
                        <span class="arrow-label">í•´ì–‘</span>
                    </div>
                </div>

                <!-- ì§€í‘œë©´ -->
                <div class="surface-section">
                    <div class="region land">
                        <div class="region-title">ğŸ”ï¸ ìœ¡ì§€</div>
                        <div class="variable-row">
                            <span class="variable-label">ê°•ìˆ˜ëŸ‰ (Pâ‚—)</span>
                            <span class="variable-value" id="P_l"></span>
                        </div>
                        <div class="variable-row">
                            <span class="variable-label">ì¦ë°œëŸ‰ (Eâ‚—)</span>
                            <span class="variable-value" id="E_l"></span>
                        </div>
                    </div>

                    <div class="runoff-section">
                        <span class="runoff-label">ìœ ì¶œëŸ‰ (R)</span>
                        <span class="runoff-arrow">â†’</span>
                        <span class="runoff-value" id="R"></span>
                    </div>

                    <div class="region ocean">
                        <div class="region-title">ğŸŒŠ í•´ì–‘</div>
                        <div class="variable-row">
                            <span class="variable-label">ê°•ìˆ˜ëŸ‰ (Pâ‚’)</span>
                            <span class="variable-value" id="P_o"></span>
                        </div>
                        <div class="variable-row">
                            <span class="variable-label">ì¦ë°œëŸ‰ (Eâ‚’)</span>
                            <span class="variable-value" id="E_o"></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="question-info" id="questionInfo"></div>

        <div class="equations-box">
            <div class="equations-title">ğŸ’¡ í•µì‹¬ ë³´ì¡´ì‹</div>
            <div class="equation-grid">
                <div class="equation">ìœ¡ì§€: Pâ‚— = Eâ‚— + R</div>
                <div class="equation">í•´ì–‘: Eâ‚’ = Pâ‚’ + R</div>
                <div class="equation">ëŒ€ê¸°: W = Pâ‚— + Pâ‚’ = Eâ‚— + Eâ‚’</div>
            </div>
        </div>

        <div class="choices-container" id="choices"></div>

        <div class="feedback" id="feedback"></div>

        <div class="controls">
            <button class="btn btn-primary" onclick="nextProblem()">ë‹¤ìŒ ë¬¸ì œ</button>
        </div>

        <div class="verification" id="verification">
            <div class="verification-title">ğŸ“Š ë³´ì¡´ì‹ ê²€ì¦ ê²°ê³¼</div>
            <div id="verificationContent"></div>
        </div>
    </div>

    <script src="core.js"></script>
    <script>
        let currentProblem = null;
        let currentBlank = null;
        let correctAnswer = null;
        let choices = [];
        let score = 0;
        let total = 0;
        let answered = false;

        function displayProblem() {
            currentProblem = generateProblem();
            answered = false;

            // ê°ê´€ì‹ì€ ë¹ˆì¹¸ 1ê°œë§Œ ì‚¬ìš©
            currentBlank = currentProblem.blanks[0];
            correctAnswer = currentProblem.answers[currentBlank];

            // ë¹ˆì¹¸ì´ 2ê°œ ì´ìƒì´ë©´ ì²« ë²ˆì§¸ë§Œ ë¹ˆì¹¸ìœ¼ë¡œ, ë‚˜ë¨¸ì§€ëŠ” ê°’ í‘œì‹œ
            if (currentProblem.blanks.length > 1) {
                for (let i = 1; i < currentProblem.blanks.length; i++) {
                    const extraBlank = currentProblem.blanks[i];
                    currentProblem.displayData[extraBlank] = currentProblem.dataset[extraBlank];
                }
            }

            document.getElementById('verification').classList.remove('show');
            document.getElementById('feedback').className = 'feedback';

            const variables = ['R', 'E_l', 'P_l', 'E_o', 'P_o', 'W'];

            variables.forEach(varName => {
                const element = document.getElementById(varName);
                if (!element) return;

                const value = currentProblem.displayData[varName];

                if (value === null) {
                    element.textContent = '?';
                    element.classList.add('blank');
                } else {
                    element.textContent = value;
                    element.classList.remove('blank');
                }
            });

            // ì§ˆë¬¸ í‘œì‹œ
            const varInfo = VARIABLES[currentBlank];
            document.getElementById('questionInfo').textContent =
                `â“ ${varInfo.label} (${varInfo.name})ì˜ ê°’ì€?`;

            // ë³´ê¸° ìƒì„±
            const wrongAnswers = generateAttractiveWrongAnswers(correctAnswer, currentBlank, currentProblem.dataset);
            choices = generateChoices(correctAnswer, wrongAnswers);

            const choicesContainer = document.getElementById('choices');
            choicesContainer.innerHTML = '';

            choices.forEach((choice, index) => {
                const btn = document.createElement('button');
                btn.className = 'choice-btn';
                btn.innerHTML = `
                    <span class="choice-number">${index + 1}</span>
                    <span>${choice}</span>
                `;
                btn.onclick = () => selectChoice(index, btn);
                choicesContainer.appendChild(btn);
            });
        }

        function selectChoice(index, btn) {
            if (answered) return;
            answered = true;

            const selectedValue = choices[index];
            const isCorrect = selectedValue === correctAnswer;

            // ëª¨ë“  ë²„íŠ¼ ë¹„í™œì„±í™”
            document.querySelectorAll('.choice-btn').forEach(b => {
                b.classList.add('disabled');
            });

            // ì„ íƒí•œ ë²„íŠ¼ ìŠ¤íƒ€ì¼
            if (isCorrect) {
                btn.classList.add('correct');
            } else {
                btn.classList.add('incorrect');
                // ì •ë‹µ í‘œì‹œ
                document.querySelectorAll('.choice-btn').forEach((b, i) => {
                    if (choices[i] === correctAnswer) {
                        b.classList.add('correct');
                    }
                });
            }

            // í”¼ë“œë°±
            total++;
            const feedback = document.getElementById('feedback');

            if (isCorrect) {
                score++;
                feedback.className = 'feedback correct';
                feedback.innerHTML = `ğŸ‰ ì •ë‹µì…ë‹ˆë‹¤! ${VARIABLES[currentBlank].name} = ${correctAnswer}`;
            } else {
                feedback.className = 'feedback incorrect';
                feedback.innerHTML = `âŒ ì˜¤ë‹µì…ë‹ˆë‹¤. ì •ë‹µì€ ${VARIABLES[currentBlank].name} = ${correctAnswer}`;
            }

            document.getElementById('score').textContent = score;
            document.getElementById('total').textContent = total;

            // ê²€ì¦ ê²°ê³¼ í‘œì‹œ
            showVerification();
        }

        function showVerification() {
            const verification = verifyConservation(currentProblem.dataset);
            const container = document.getElementById('verificationContent');

            container.innerHTML = `
                <div class="verification-row">
                    <span>ìœ¡ì§€ ë¬¼ìˆ˜ì§€: ${verification.land.equation}</span>
                    <span class="verification-status balanced">âœ“ ê· í˜•</span>
                </div>
                <div class="verification-row">
                    <span>í•´ì–‘ ë¬¼ìˆ˜ì§€: ${verification.ocean.equation}</span>
                    <span class="verification-status balanced">âœ“ ê· í˜•</span>
                </div>
                <div class="verification-row">
                    <span>ëŒ€ê¸°(ê°•ìˆ˜): ${verification.atmosphere.equation}</span>
                    <span class="verification-status balanced">âœ“ ê· í˜•</span>
                </div>
                <div class="verification-row">
                    <span>ëŒ€ê¸°(ì¦ë°œ): ${verification.evaporation.equation}</span>
                    <span class="verification-status balanced">âœ“ ê· í˜•</span>
                </div>
            `;

            document.getElementById('verification').classList.add('show');
        }

        function nextProblem() {
            displayProblem();
        }

        // í‚¤ë³´ë“œ ë‹¨ì¶•í‚¤ (1-5)
        document.addEventListener('keypress', function(e) {
            if (answered) return;

            const num = parseInt(e.key);
            if (num >= 1 && num <= 5) {
                const btns = document.querySelectorAll('.choice-btn');
                if (btns[num - 1]) {
                    selectChoice(num - 1, btns[num - 1]);
                }
            }
        });

        // ì´ˆê¸°í™”
        displayProblem();
    </script>
</body>
</html>
